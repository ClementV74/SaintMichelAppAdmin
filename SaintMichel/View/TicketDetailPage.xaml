<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:model="clr-namespace:SaintMichel.Model"
             x:Class="SaintMichel.View.TicketDetailPage"
             BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#212529}"
             Title="Détail du Ticket">
    
    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- En-tête avec titre et statut -->
        <Grid RowDefinitions="Auto,Auto" Padding="20" 
              BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#343A40}"
              Shadow="{Shadow Offset='0,4', Opacity=0.1, Radius=8, Brush=#000000}">

            <!-- Titre et date -->
            <Grid ColumnDefinitions="*,Auto">
                <Label Text="{Binding Title}" FontAttributes="Bold" FontSize="24" 
                       TextColor="{AppThemeBinding Light=#212529, Dark=#F8F9FA}"
                       LineBreakMode="WordWrap" />

                <Label Grid.Column="1" 
                       Text="{Binding DateCreation, StringFormat='{0:dd/MM/yyyy}'}" 
                       FontSize="14" TextColor="{AppThemeBinding Light=#6C757D, Dark=#ADB5BD}"
                       VerticalOptions="Center" />
            </Grid>

            <!-- Description -->
            <Label Grid.Row="1" Text="{Binding Description}" FontSize="16" 
                   TextColor="{AppThemeBinding Light=#6C757D, Dark=#CED4DA}"
                   Margin="0,10,0,0" LineBreakMode="WordWrap" />
        </Grid>

        <!-- Section statut - Bouton sur la même ligne -->
        <Frame Grid.Row="1" Margin="20,15" Padding="0" HasShadow="True" 
               BorderColor="Transparent" CornerRadius="10"
               BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#343A40}">
            <Grid ColumnDefinitions="Auto,*,Auto" Padding="15">
                <Label Text="Statut" FontAttributes="Bold" FontSize="16" 
                       TextColor="{AppThemeBinding Light=#212529, Dark=#F8F9FA}"
                       VerticalOptions="Center" />

                <!-- Badge de statut -->
                <Border Grid.Column="1" 
                        BackgroundColor="{Binding StatusColor}"
                        StrokeThickness="0"
                        Padding="12,6" 
                        StrokeShape="RoundRectangle 15,15,15,15"
                        HorizontalOptions="Start"
                        Margin="15,0,0,0">
                    <Label Text="{Binding Status}" 
                           FontSize="14" FontAttributes="Bold"
                           TextColor="White" />
                </Border>

                <!-- Bouton de changement de statut - Maintenant sur la même ligne -->
                <Button Grid.Column="2" Text="Changer le statut" 
                        Command="{Binding ToggleStatusCommand}"
                        BackgroundColor="#4361EE" TextColor="White"
                        CornerRadius="8"
                        HorizontalOptions="End" />
            </Grid>
        </Frame>

        <!-- Section chat (messages) -->
        <RefreshView Grid.Row="2" Command="{Binding RefreshMessagesCommand}" IsRefreshing="{Binding IsRefreshing}">
            <CollectionView ItemsSource="{Binding Messages}" 
                            Margin="20,5,20,0" 
                            ItemsUpdatingScrollMode="KeepLastItemInView">
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center">
                        <Label Text="Aucun message" FontSize="16" TextColor="Gray" 
                               HorizontalOptions="Center" />
                        <Label Text="Commencez la conversation..." FontSize="14" TextColor="Gray" 
                               HorizontalOptions="Center" Margin="0,5,0,0" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:Message">
                        <Grid ColumnDefinitions="*,*" Padding="5,0">
                            <!-- Message du support (à droite) ou de l'utilisateur (à gauche) -->
                            <Frame Grid.Column="{Binding IsFromCurrentUser, Converter={StaticResource BoolToColumnConverter}}"
                                   BackgroundColor="{Binding IsFromCurrentUser, Converter={StaticResource MessageColorConverter}}"
                                   BorderColor="Transparent"
                                   CornerRadius="12"
                                   Padding="12,8"
                                   HasShadow="False"
                                   HorizontalOptions="{Binding IsFromCurrentUser, Converter={StaticResource MessageAlignmentConverter}}">
                                <StackLayout Spacing="4">
                                    <Label Text="{Binding sender_name}" 
                                           FontSize="12" 
                                           FontAttributes="Bold"
                                           TextColor="{Binding IsFromCurrentUser, Converter={StaticResource MessageTextColorConverter}}" />

                                    <Label Text="{Binding content}" 
                                           TextColor="{Binding IsFromCurrentUser, Converter={StaticResource MessageTextColorConverter}}"
                                           FontSize="14" />

                                    <Label Text="{Binding timestamp, StringFormat='{0:HH:mm, dd MMM}'}" 
                                           FontSize="10" 
                                           TextColor="{Binding IsFromCurrentUser, Converter={StaticResource MessageTimeColorConverter}}"
                                           HorizontalOptions="End" />
                                </StackLayout>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Zone de saisie de message -->
        <Grid Grid.Row="3" ColumnDefinitions="*,Auto" Padding="15" 
              BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#343A40}"
              Shadow="{Shadow Offset='0,-4', Opacity=0.1, Radius=8, Brush=#000000}">
            <Frame BorderColor="{AppThemeBinding Light=#DEE2E6, Dark=#495057}"
                   BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#343A40}"
                   CornerRadius="20"
                   Padding="15,0"
                   HasShadow="False">
                <Entry Text="{Binding NewMessage}" 
                       Placeholder="Tapez votre message..." 
                       PlaceholderColor="{AppThemeBinding Light=#ADB5BD, Dark=#6C757D}"
                       TextColor="{AppThemeBinding Light=#212529, Dark=#F8F9FA}"
                       BackgroundColor="Transparent"
                       ReturnCommand="{Binding SendMessageCommand}"
                       ReturnType="Send"
                       VerticalOptions="Center" />
            </Frame>

            <Button Grid.Column="1" 
                    Text="Envoyer" 
                    Command="{Binding SendMessageCommand}"
                    BackgroundColor="#4361EE" 
                    TextColor="White"
                    CornerRadius="20"
                    Margin="10,0,0,0"
                    HeightRequest="40"
                    WidthRequest="80" />
        </Grid>
    </Grid>
</ContentPage>